from socket import *
import struct

sdp_record = b'\x36\x03\x2e\x36\x00\x8e\x09\x00\x00\x0a\x00\x00\x00\x00\x09\x00\x01\x35\x03\x19\x10\x00\x09\x00\x04\x35\x0d\x35\x06\x19\x01\x00\x09\x00\x01\x35\x03\x19\x00\x01\x09\x00\x05\x35\x03\x19\x10\x02\x09\x00\x06\x35\x09\x09\x65\x6e\x09\x00\x6a\x09\x01\x00\x09\x00\x09\x35\x08\x35\x06\x19\x01\x00\x09\x01\x00\x09\x01\x00\x25\x25\x4c\x6f\x67\x69\x74\x65\x63\x68\x20\x4b\x37\x36\x30\x20\x53\x6f\x6c\x61\x72\x20\x4b\x65\x79\x62\x6f\x61\x72\x64\x20\x20\x20\x20\x20\x20\x20\x20\x20\x09\x01\x01\x25\x12\x42\x6c\x75\x65\x74\x6f\x6f\x74\x68\x20\x4b\x65\x79\x62\x6f\x61\x72\x64\x09\x02\x00\x35\x03\x09\x01\x00\x36\x02\x9a\x09\x00\x00\x0a\x00\x01\x00\x00\x09\x00\x01\x35\x03\x19\x11\x24\x09\x00\x04\x35\x0d\x35\x06\x19\x01\x00\x09\x00\x11\x35\x03\x19\x00\x11\x09\x00\x05\x35\x03\x19\x10\x02\x09\x00\x06\x35\x09\x09\x65\x6e\x09\x00\x6a\x09\x01\x00\x09\x00\x09\x35\x08\x35\x06\x19\x11\x24\x09\x01\x01\x09\x00\x0d\x35\x0f\x35\x0d\x35\x06\x19\x01\x00\x09\x00\x13\x35\x03\x19\x00\x11\x09\x01\x00\x25\x33\x4c\x6f\x67\x69\x74\x65\x63\x68\x20\x4b\x37\x36\x30\x20\x53\x6f\x6c\x61\x72\x20\x4b\x65\x79\x62\x6f\x61\x72\x64\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x09\x01\x01\x25\x12\x42\x6c\x75\x65\x74\x6f\x6f\x74\x68\x20\x4b\x65\x79\x62\x6f\x61\x72\x64\x09\x01\x02\x25\x10\x4c\x6f\x67\x69\x74\x65\x63\x68\x20\x20\x20\x20\x20\x20\x20\x20\x09\x02\x01\x09\x01\x11\x09\x02\x02\x08\xc0\x09\x02\x03\x08\x21\x09\x02\x04\x28\x01\x09\x02\x05\x28\x01\x09\x02\x06\x36\x01\x85\x36\x01\x82\x08\x22\x26\x01\x7d\x05\x01\x09\x06\xA1\x01\x85\x01\x75\x01\x95\x08\x05\x07\x19\xE0\x29\xE7\x15\x00\x25\x01\x81\x02\x95\x01\x75\x08\x81\x03\x95\x05\x75\x01\x05\x08\x19\x01\x29\x05\x91\x02\x95\x01\x75\x03\x91\x03\x95\x06\x75\x08\x15\x00\x26\xFF\x00\x05\x07\x19\x00\x29\xFF\x81\x00\xC0\x05\x0C\x09\x01\xA1\x01\x85\x02\x15\x00\x25\x01\x75\x01\x95\x12\x0A\x94\x01\x0A\x92\x01\x0A\x83\x01\x0A\x23\x02\x0A\x8A\x01\x0A\x82\x01\x0A\x21\x02\x0A\x30\x00\x0A\x25\x02\x0A\x23\x02\x0A\x27\x02\x09\xB6\x09\xB5\x09\xB8\x09\xCD\x09\xE9\x09\xEA\x09\xE2\x81\x02\x95\x01\x75\x06\x81\x03\xC0\x05\x0C\x09\x01\xA1\x01\x85\x03\x05\x01\x09\x06\xA1\x02\x05\x06\x09\x20\x15\x00\x26\xFF\x00\x75\x08\x95\x01\x81\x02\xC0\xC0\x05\x01\x09\x80\xA1\x01\x85\x04\x15\x00\x25\x01\x75\x01\x95\x01\x09\x82\x81\x02\x95\x01\x75\x07\x81\x03\xC0\x05\x0C\x09\x01\xA1\x01\x85\x05\x05\x01\x09\x06\xA1\x02\x06\x00\xFF\x25\x01\x75\x01\x95\x02\x0A\x03\xFE\x0A\x04\xFE\x81\x02\x95\x06\x81\x03\xC0\xC0\x05\x0C\x09\x01\xA1\x01\x85\xFF\x05\x06\x95\x01\x75\x02\x19\x24\x29\x26\x81\x02\x75\x06\x81\x01\xC0\x06\x00\xFF\x09\x01\xA1\x01\x85\x10\x75\x08\x95\x06\x15\x00\x26\xFF\x00\x09\x01\x81\x00\x09\x01\x91\x00\xC0\x06\x00\xFF\x09\x02\xA1\x01\x85\x11\x75\x08\x95\x13\x15\x00\x26\xFF\x00\x09\x02\x81\x00\x09\x02\x91\x00\xC0\x05\x01\x09\x02\xA1\x01\x85\x12\x09\x01\xA1\x00\x05\x09\x19\x01\x29\x10\x15\x00\x25\x01\x95\x10\x75\x01\x81\x02\x05\x01\x16\x01\x80\x26\xFF\x7F\x75\x10\x95\x02\x09\x30\x09\x31\x81\x06\x15\x81\x25\x7F\x75\x08\x95\x01\x09\x38\x81\x06\x05\x0C\x0A\x38\x02\x95\x01\x81\x06\xC0\xC0\x09\x02\x07\x35\x08\x35\x06\x09\x04\x09\x09\x01\x00\x09\x02\x08\x28\x00\x09\x02\x09\x28\x01\x09\x02\x0a\x28\x01\x09\x02\x0c\x09\x26\x20\x09\x02\x0d\x28\x00\x09\x02\x0e\x28\x01\x09\x02\x0f\x09\x0c\x60\x09\x02\x10\x09\x00\x00'


sdp_record_pnp = b'\x35\x00'

service_record_pnp = b'\x00\x00\x00\x00'
service_record_hid = b'\x00\x01\x00\x01\x00\x01\x00\x00'

attr_record_hid = sdp_record[148:]

while True:
    ss = socket(AF_BLUETOOTH, SOCK_STREAM, BTPROTO_L2CAP)
    ss.bind(("20:C9:D0:B9:5F:EE", 1))
    ss.listen(1)
    sc,addr=ss.accept()

    while True:
        index = 0
        extended = True
       
        try:
            input = sc.recv(64)

            if input[0:1] == b'\x06' and input[8:10] == b'\x01\x00':
                header = b'\x07'
                record = sdp_record
            elif input[0:1] == b'\x06' and input[8:10] == b'\x12\x00':
                header = b'\x07'
                record = sdp_record_pnp
            elif input[0:1] == b'\x02' and input[8:10] == b'\x12\x00':
                header = b'\x03'
                record = service_record_pnp
                extended = False
            elif input[0:1] == b'\x02' and input[8:10] == b'\x11\x24':
                header = b'\x03'
                record = service_record_hid
                extended = False
            elif input[0:1] == b'\x04' and input[5:9] == b'\x00\x01\x00\x00':
                header = b'\x05'
                record = attr_record_hid
            else:
                print(input)

            if extended == True:
                while index + 0x26 < len(record):
                    output = header + input[1:3] + b'\x00\x2b' + b'\x00\x26' + record[index:index + 0x26] + b'\x02\x03\x44'
                    sc.send(output)
                    index = index + 0x26
                    input = sc.recv(64)

                output = header + input[1:3] + struct.pack('>H', len(record) - index + 3) + struct.pack('>H', len(record) - index) + record[index:] + b'\x00'
                sc.send(output)
            else:
                output = header + input[1:3] + struct.pack('>H', len(record) + 1) + record + b'\x00'
                sc.send(output)
   
            ss.close()
        except:
            print("Reconnecting")
            break
